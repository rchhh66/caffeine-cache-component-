<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>缓存详情 - [[${cacheName}]]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #2196F3; }
        input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
    </style>
</head>
<body>
    <th:block th:replace="fragments/navbar :: navbar"></th:block>
    <div class="container">
        <h1 class="mb-4">缓存详情 - [[${cacheName}]]</h1>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">配置信息</h2>
            </div>
            <div class="card-body">
                <form action="/caffeine-admin/cache/update/[[${cacheName}]]" method="post">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label for="offHeapCacheEnabled" class="form-label">堆外缓存</label>
                            <label class="switch">
                                <input type="checkbox" id="offHeapCacheEnabled" name="offHeapCacheEnabled" th:checked="${config.offHeapCacheEnabled}">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label for="persistenceEnabled" class="form-label">持久化到磁盘</label>
                            <label class="switch">
                                <input type="checkbox" id="persistenceEnabled" name="persistenceEnabled" th:checked="${config.persistenceEnabled}">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label for="asyncWarmupEnabled" class="form-label">异步预热</label>
                            <label class="switch">
                                <input type="checkbox" id="asyncWarmupEnabled" name="asyncWarmupEnabled" th:checked="${config.asyncWarmupEnabled}">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="maximumSize" class="form-label">最大容量</label>
                        <input type="number" class="form-control" id="maximumSize" name="maximumSize" th:value="${config.maximumSize}">
                    </div>
                    <div class="mb-3">
                        <label for="expireAfterWrite" class="form-label">过期时间(秒)</label>
                        <input type="number" class="form-control" id="expireAfterWrite" name="expireAfterWrite" th:value="${config.expireAfterWrite}">
                    </div>
                    <div class="mb-3">
                        <label for="persistencePath" class="form-label">持久化路径</label>
                        <input type="text" class="form-control" id="persistencePath" name="persistencePath" th:value="${config.persistencePath}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="persistenceInterval" class="form-label">持久化间隔(秒)</label>
                        <input type="number" class="form-control" id="persistenceInterval" name="persistenceInterval" th:value="${config.persistenceInterval}" readonly>
                    </div>
                    <button type="submit" class="btn btn-primary">更新配置</button>
                    <a href="/caffeine-admin/cache/manage" class="btn btn-secondary ms-2">返回</a>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 建立WebSocket连接
        const cacheName = '[[' + '${cacheName}' + ']]';
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = wsProtocol + window.location.host + '/caffeine-admin/ws/cache-config';
        const socket = new WebSocket(wsUrl);

        // 连接建立时
        socket.onopen = function() {
            console.log('WebSocket连接已建立');
        };

        // 接收消息时
        socket.onmessage = function(event) {
            const message = JSON.parse(event.data);
            console.log('收到消息:', message);

            // 检查是否是当前缓存的配置变更
            if (message.type === 'config_change' && message.cacheName === cacheName) {
                const newConfig = message.newConfig;
                console.log('缓存配置已更新:', newConfig);

                // 更新页面上的配置信息
                document.getElementById('offHeapCacheEnabled').checked = newConfig.offHeapCacheEnabled;
                document.getElementById('persistenceEnabled').checked = newConfig.persistenceEnabled;
                document.getElementById('asyncWarmupEnabled').checked = newConfig.asyncWarmupEnabled;
                document.getElementById('maximumSize').value = newConfig.maximumSize;
                document.getElementById('expireAfterWrite').value = newConfig.expireAfterWrite;
                document.getElementById('persistencePath').value = newConfig.persistencePath;
                document.getElementById('persistenceInterval').value = newConfig.persistenceInterval;

                // 显示通知
                showNotification('缓存配置已更新');
            }
        };

        // 连接关闭时
        socket.onclose = function() {
            console.log('WebSocket连接已关闭');
            // 尝试重连
            setTimeout(() => { window.location.reload(); }, 3000);
        };

        // 发生错误时
        socket.onerror = function(error) {
            console.error('WebSocket错误:', error);
        };

        // 显示通知函数
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'alert alert-success fixed-top m-4 col-md-4 mx-auto';
            notification.role = 'alert';
            notification.innerHTML = `
                <strong>${message}</strong>
            `;

            // 添加到页面
            document.body.appendChild(notification);

            // 3秒后移除通知
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>